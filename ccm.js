/**
 * @overview Framework of the Client-side Component Model (<i>ccm</i>)
 * @author André Kless <andre.kless@web.de> 2014-2016
 * @copyright Copyright (c) 2014-2016 André Kless
 * @license
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software
 * and associated documentation files (the "Software"), to deal in the Software without restriction,
 * including without limitation the rights to use, copy, publish, distribute, sublicense, and/or sell
 * (<b>NOT MODIFY OR MERGE</b>) copies of the Software, and to permit persons to whom the Software is furnished
 * to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
 * LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * All rights that the author André Kless do not expressly grant in these Terms are reserved by the author André Kless.
 * @version latest (6.3.2)
 * @changes
 * version 6.3.2 (08.07.2016):
 * - bugfix for ccm datastores with user instance
 * version 6.3.1 (04.07.2016):
 * - automatic deletion of key property in ccm html data
 * version 6.3.0 (29.06.2016):
 * - privatization of datastore members
 * - delayed datastore initialization in case of usage via ccm dependency
 * - deletion of datastore init method after one-time call
 * - refactoring of some helper function
 * - improve doc comments for ccm datastore setting
 * - support of ccm instance for user authentication in ccm datastores
 * version 6.2.0 (23.06.2016):
 * - add helper function for privatization
 * - add support of attribute "async" in ccm html data
 * - ccm framework instead of ccm runtime environment
 * - rename ccm.type to ccm.types
 * - bugfix in ccm.helper.html
 * - updated doc comments for api
 * version 6.1.0 (18.05.2016):
 * - accept jQuery element instead of instance config as parameter in ccm.instance and ccm.render
 * - load jQuery remote from CDN instead of local file
 * - beginning of new convention for component filenames (old way also supported, but deprecated)
 * version 6.0.0 (09.05.2016):
 * - placeholder with %% instead of % (incompatible change)
 * (for older version changes see ccm-5.8.3.js)
 */
window.jQuery||(document.body?(window.jQuery=document.createElement("script"),window.jQuery.setAttribute("src","https://code.jquery.com/jquery-2.2.3.min.js"),document.head.appendChild(window.jQuery)):document.write('<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>')),document.body?(window.ccm=document.createElement("style"),window.ccm.appendChild(document.createTextNode("@keyframes ccm_loading { to { transform: rotate(360deg); } }")),document.head.appendChild(window.ccm)):document.write("<style>@keyframes ccm_loading { to { transform: rotate(360deg); } }</style>"),ccm=function(){function e(e){if(-1===e.indexOf(".js"))return e;var n=e.split("/").pop(),t=n.split(".");return"ccm"!==t[0]||"js"!==t[t.length-1]||3!==t.length&&"min"!==t[2]?n.substr(0,n.lastIndexOf(".")):t[1]}function n(e){var n=JSON.stringify(e);return"{}"===n&&(n=Object.keys(i).length),n}var t,c={},r={},i={},o={},a=function(){function e(e,t){function c(){function n(){i--,0===i&&t&&t(c)}var c=[],i=1;for(var o in f.local)if(ccm.helper.isSubset(e,f.local[o])){var a=ccm.helper.clone(f.local[o]);c.push(a),i++,r(a,n)}return n(),c}function r(e,t){function c(e,t){return null===i[n(e[t][1])]?a.push([c,e,t]):(o++,void ccm.helper.solveDependency(e,t,r))}function r(){return o--,0===o?a.length>0?ccm.helper.action(a.pop()):void(t&&t(e)):void 0}var o=1,a=[];for(var s in e){var u=e[s];if(ccm.helper.isDependency(u))c(e,s);else if(jQuery.isArray(u))for(var l=0;l<u.length;l++)ccm.helper.isDependency(u[l])&&c(u,l)}r()}if(void 0===e||jQuery.isPlainObject(e))return c();var o=f.local[e]||null;return o&&(o=Array.isArray(o)?o.slice(0):ccm.helper.clone(f.local[e])),r(o,t),o}function c(n,t){return f.local[n.key]?ccm.helper.integrate(n,f.local[n.key]):f.local[n.key]=n,e(n.key,t)}function r(e,n){var t;return void 0===e?(t=f.local,f.local={}):(t=f.local[e],delete f.local[e]),n&&n(t),t}function o(){var e=t.transaction([f.store],"readwrite");return e.objectStore(f.store)}function a(e){return e=ccm.helper.integrate(e,{db:f.db,store:f.store}),f.user&&f.user.isLoggedIn()&&(e=ccm.helper.integrate(e,{user:f.user.data().key,token:f.user.data().token})),e}function s(e,n){p.push(n),e.callback=p.length,f.socket.send(JSON.stringify(e))}function u(e,n){ccm.load([f.url,e],n)}function l(e){return"string"!=typeof e||0!==e.indexOf("[ccm]")}var f,p=[];this.init=function(e){f=ccm.helper.privatize(this,"local","store","url","db","socket","onChange","user"),f.socket&&(f.socket.onmessage=function(e){if(e=JSON.parse(e.data),e.callback)p[e.callback-1](e.data);else{var n=jQuery.isPlainObject(e)?c(e):r(e);f.onChange&&f.onChange(n,e)}}),e&&e()},this.get=function(n,t){function c(){return e(n,t)}function r(){var e=p();if(e)return e;var c=o(),r=c.get(n);r.onsuccess=function(e){var c=e.target.result;return c?(void 0!==c.key&&(f.local[n]=c),void(t&&t(c))):t(null)}}function i(){function e(e){if(l(e)){if(!e)return t(null);if(ccm.helper.isDataset(e))f.local[e.key]=e;else for(var n=0;n<e.length;n++)void 0!==e[n].key&&(f.local[e[n].key]=e[n]);t&&t(e)}}if(!jQuery.isPlainObject(n)){var c=p();if(c)return c}var r=a({key:n});f.socket?s(r,e):u(r,e)}function p(){var c=e(n);return c&&t&&t(c),c}return"function"==typeof n&&(t=n,n={}),void 0===n&&(n={}),f.url?i():f.store?r():f.local?c():void 0},this.set=function(e,n){function t(){return c(e,n)}function r(){var n=o(),c=n.put(e);c.onsuccess=t}function i(){function n(n){l(n)&&(e=n,t())}var c=a({dataset:e});f.socket?s(c,n):u(c,n)}return e.key||(e.key=ccm.helper.generateKey()),f.url?i():f.store?r():f.local?t():void 0},this.del=function(e,n){function t(){return r(e,n)}function c(){var n=o(),c=n["delete"](e);c.onsuccess=t}function i(){function c(e){l(e)&&(n&&n(e),n=void 0,t())}var r=a({del:e});f.socket?s(r,c):u(r,c)}return f.url?i():f.store?c():f.local?t():void 0}};return{callback:{},loading_icon:"./img/ccm-load-icon.gif",version:[6,3,2],load:function(){function n(n,s){function l(e){if(null!==e&&a[s].push(e),n.length>0){var c=n.shift();!Array.isArray(c)||c.length>1&&ccm.helper.isObject(c[1])?ccm.load(c,l):(c.push(l),ccm.load.apply(null,c))}else t()}function p(){if(!g()){if(0!==n.indexOf("http"))return jQuery.ajax({url:n,cache:!1,dataType:"html",crossDomain:!0,success:b});var e=n.split("/").pop();ccm.callback[e]=b,jQuery("head").append('<script src="'+n+'"></script>')}}function d(){Q||jQuery("head").append('<link rel="stylesheet" type="text/css" href="'+n+'">'),k()}function m(){Q||jQuery('<img src="'+n+'">'),k()}function h(){g()||jQuery.getScript(n,j).fail(x)}function y(){if(!g()){if(0!==n.indexOf("http"))return jQuery.getJSON(n,b).fail(x);var e=n.split("/").pop();ccm.callback[e]=b,jQuery("head").append('<script src="'+n+'"></script>')}}function v(){f||(0===n.indexOf("http")?jQuery.ajax({url:n,data:w,dataType:"jsonp",username:w&&w.username?w.username:void 0,password:w&&w.password?w.password:void 0,success:b}):jQuery.ajax({url:n,data:w,username:w&&w.username?w.username:void 0,password:w&&w.password?w.password:void 0,success:b}).fail(x))}function g(){return null===Q?f?!0:(f=!0,o[n]||(o[n]=[]),o[n].push(u),!0):Q?(a[s]=r[n]=Q,k(),!0):!1}function j(){var t=e(n),i=c[t];if(!i)return k();for(a[s]=r[n]=i;o[i.index]&&o[i.index].length>0;)ccm.helper.action(o[i.index].pop());k()}function b(e){a[s]=r[n]=e,k()}function k(){for(r[n]||(r[n]=n);o[n]&&o[n].length>0;)ccm.helper.action(o[n].pop());t()}function x(e,n,t){console.log(e,this.url),jQuery("body").html(e.responseText+"<p>Request Failed: "+n+", "+t+"</p>")}var w;if(jQuery.isArray(n)){if(!(n.length>1&&ccm.helper.isObject(n[1])))return i++,a[s]=[],l(null);w=n[1],n=n[0]}var Q=r[n];if(r[n]=null,i++,w)return v();var O=n.split(".").pop();switch(O){case"html":return p();case"css":return d();case"jpg":case"gif":case"png":case"svg":return m();case"js":return h();case"json":return y();default:v()}}function t(){return i--,0===i?(a.length<=1&&(a=a[0]),l&&l(a),a):void 0}var i=1,a=[],s=Array.prototype.slice.call(arguments),u=s.slice(0);u.unshift(ccm.load);var l,f=!1;"function"!=typeof s[s.length-1]&&void 0!==s[s.length-1]||(l=s.pop());for(var p=0;p<s.length;p++)n(s[p],p);return t()},component:function(e,n,t){function r(){t&&t(e)}function i(){if(e.index){var n=e.index.split("-");e.name=n[0],n.length>1&&(e.version=n[1].split("."));for(var t=0;3>t;t++)e.version[t]=parseInt(e.version[t])}e.index=e.name,e.version&&(e.index+="-"+e.version.join("."))}function o(){e.instances=0,e.instance=function(n,t){return ccm.instance(e.index,n,t)},e.render=function(n,t){return ccm.render(e.index,n,t)},ccm.helper.integrate(n,e.config),e.config||(e.config={}),e.config.element||(e.config.element=jQuery("body"))}return"function"==typeof n&&(t=n,n=void 0),"string"==typeof e?ccm.load(e,function(e){ccm.helper.integrate(n,e.config),t&&t(e)}):(i(),c[e.index]?c[e.index]:(o(),c[e.index]=e,void(e.init?(e.init(r),delete e.init):r())))},instance:function(n,t,r){function i(n,t,s,u,l){function f(){function e(e){function n(e){function c(e,n){function c(c){e[n]=c,t()}function r(e,n,t,c,r){function i(n){t[c]={component:e,parent:r,render:function(r){delete this.component,delete this.render,n||(n={}),ccm.helper.integrate(this,n),ccm.render(e,n,function(e){t[c]=e,r&&r()})}}}ccm.helper.isDependency(n)?ccm.dataset(n[1],n[2],i):i(n)}var o=e[n];switch(o[0]){case ccm.load:case"ccm.load":a++,ccm.load(o[1],c);break;case ccm.component:case"ccm.component":a++,ccm.component(o[1],o[2],c);break;case ccm.instance:case"ccm.instance":i(o[1],o[2],e,n,d);break;case ccm.proxy:case"ccm.proxy":r(o[1],o[2],e,n,d);break;case ccm.store:case"ccm.store":a++,o[1]||(o[1]={}),o[1].delayed=!0,ccm.store(o[1],c);break;case ccm.dataset:case"ccm.dataset":a++,ccm.dataset(o[1],o[2],c)}}for(var r in e){var o=e[r];if(ccm.helper.isDependency(o))c(e,r);else if("object"==typeof o&&null!==o){if(ccm.helper.isElement(o)||ccm.helper.isInstance(o)||ccm.helper.isComponent(o))continue;n(o)}}}function t(){return a--,0===a&&f(o,function(){r&&r(o)}),0===a?o:null}function f(e,n){function t(e){(ccm.helper.isInstance(e)||ccm.helper.isDatastore(e))&&i.push(e);for(var n in e){var c=e[n];if(ccm.helper.isInstance(c)&&"parent"!==n&&!ccm.helper.isProxy(c))t(c);else if("object"==typeof c&&null!==c){if(ccm.helper.isElement(c)||ccm.helper.isInstance(c)||ccm.helper.isComponent(c))continue;t(c)}}}function c(){if(o===i.length)return r();var e=i[o];o++,e.init?(e.init(c),delete e.init):c()}function r(){if(0===i.length)return n();var e=i.pop();e.ready?(e.ready(r),delete e.ready):r()}var i=[];t(e);var o=0;c()}var d=new c[p].Instance;switch(c[p].instances++,s&&(s[u]=d),l&&(d.parent=l),o||(o=d),d.id=c[p].instances,d.index=p+"-"+d.id,d.component=c[p],ccm.helper.integrate(c[p].config,d),e&&ccm.helper.integrate(e,d),d.element){case"name":d.element=ccm.helper.find(l,"."+d.component.name);break;case"parent":d.element=l.element}return n(d),t()}return ccm.helper.isDependency(t)?ccm.dataset(t[1],t[2],e):e(t)}var p=e(n);return a++,c[p]?f():ccm.load(n,f)}"function"==typeof t&&(r=t,t=void 0),ccm.helper.isElement(t)&&(t={element:t});var o,a=0;return i(n,t)},render:function(e,n,t){ccm.instance(e,n,function(e){e.render(function(){t&&t(e)})})},store:function(e,c){function r(n){function r(n){function c(e){var n=indexedDB.open("ccm");n.onsuccess=function(){t=this.result,e()}}function r(){function c(n){var c=parseInt(localStorage.getItem("ccm"));c||(c=1),t.close();var r=indexedDB.open("ccm",c+1);r.onupgradeneeded=function(){t=this.result,localStorage.setItem("ccm",t.version),t.createObjectStore(e.store,{keyPath:"key"})},r.onsuccess=n}t.objectStoreNames.contains(e.store)?n():c(n)}t?r():c(r)}function s(){function n(){return t.delayed?delete t.delayed:(t.init(),delete t.init),i[o]=t,c&&c(t),t}var t=new a;return ccm.helper.integrate(e,t),t.url&&0===t.url.indexOf("ws")?(t.socket=new WebSocket(t.url,"ccm"),void(t.socket.onopen=function(){this.send([t.db,t.store]),n()})):n()}return e.local=n,e.store&&!e.url?r(s):s()}"function"==typeof e&&(c=e,e=void 0),e||(e={}),"string"!=typeof e&&(!ccm.helper.isObject(e)||e.local||e.store||e.url||e.delayed||e.user)||(e={local:e}),e=ccm.helper.clone(e);var o=n(e);return i[o]?(c&&c(i[o]),i[o]):(e.local||(e.local={}),"string"==typeof e.local?ccm.load(e.local,r):r(e.local))},dataset:function(e,n,t){var c=ccm.store(e,function(e){e.get(n,t)});return c?c.get(n):void 0},context:{find:function(e,n){for(var t=e;e=e.parent;)if(e[n]&&e[n]!==t)return e[n]},root:function(e){for(;e.parent;)e=e.parent;return e}},helper:{action:function(e,n){return"function"==typeof e?e():("object"!=typeof e&&(e=e.split(" ")),"function"==typeof e[0]?e[0].apply(window,e.slice(1)):0===e[0].indexOf("this.")?this.executeByName(e[0].substr(5),e.slice(1),n):this.executeByName(e[0],e.slice(1)))},clone:function(e,n){return"object"==typeof e?jQuery.extend(!n,{},e):void 0},dataset:function(e,n){e.store.get(e.key,function(t){function c(t){e.key=t.key,n&&n(t)}null===t?e.store.set({key:e.key},c):c(t)})},element:function(e){ccm.helper.reselect(e);var n=e.component.name;jQuery.isArray(e.classes)&&(e.classes=e.classes.join(" ")),e.element.html('<div id="ccm-'+e.index+'" class="ccm '+(e.classes?e.classes:"ccm-"+n)+'"></div>');var t=e.element.find('div[id="ccm-'+e.index+'"]');return ccm.helper.loading(t),t},executeByName:function(e,n,t){t||(t=window);var c=e.split(".");e=c.pop();for(var r=0;r<c.length;r++)t=t[c[r]];return t[e].apply(t,n)},filter:function(e,n){e=ccm.helper.clone(e);for(var t in e)e[t]===n[t]&&delete e[t]},find:function(e,n,t){return"string"==typeof n&&(t=n,n=void 0),n||(n=e.element),n.find(t+":not(.ccm, #ccm-"+e.index+" .ccm *)")},focusInput:function(e,n){e=e.get(0),void 0===n&&(n=e.value.length),e.selectionStart=e.selectionEnd=n,e.focus()},format:function(e,n){function t(e){return e.replace(/"/g,"'").replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f")}var c=[[],[]];e=JSON.stringify(e,function(e,n){return"function"==typeof n?(c[0].push(n),"%f0%"):n});for(var r=1;r<arguments.length;r++)if("function"==typeof arguments[r]&&(c[1].push(arguments[r]),arguments[r]="%f1%"),"object"==typeof arguments[r])for(var i in arguments[r])"function"==typeof arguments[r][i]&&(c[1].push(arguments[r][i]),arguments[r][i]="%f1%"),"string"==typeof arguments[r][i]&&(arguments[r][i]=t(arguments[r][i])),e=e.replace(new RegExp("%"+i+"%","g"),arguments[r][i]);else"string"==typeof arguments[r]&&(arguments[r]=t(arguments[r])),e=e.replace(/%%/,arguments[r]);return JSON.parse(e,function(e,n){return"%f0%"===n?c[0].shift():"%f1%"===n?c[1].shift():n})},formData:function(e){e.find("input[type=checkbox]").each(function(){var e=jQuery(this);e.is(":checked")||(e.attr("data-input",e.attr("value")),e.attr("value","")),e.prop("checked",!0)});var n=e.serializeArray();e.find('input[type=checkbox][value=""]').each(function(){var e=jQuery(this);e.prop("checked",!1),e.attr("value",e.attr("data-input")),e.removeAttr("data-input")});for(var t={},c=0;c<n.length;c++)t[n[c].name]=n[c].value;return t},generateKey:function(){return Date.now()+"X"+Math.random().toString().substr(2)},getCursor:function(e){return e.get(0).selectionStart},getElementID:function(e){return"ccm-"+e.index},html:function(e,n){if(arguments.length>1&&(e=ccm.helper.format.apply(this,arguments)),jQuery.isArray(e)){for(var t=[],c=0;c<e.length;c++)t.push(ccm.helper.html(e[c]));return t}if("string"==typeof e&&(e=ccm.helper.val(e)),"object"!=typeof e)return e;var r=jQuery("<"+ccm.helper.val(e.tag||"div",!0)+">");delete e.tag,delete e.key;for(var i in e){var o=e[i];switch(i){case"async":case"checked":case"disabled":case"readonly":case"required":case"selected":o&&"undefined"!==o&&"false"!==o&&r.prop(i,!0);break;case"inner":r.html(this.html(o));break;case"onblur":r.blur(o);break;case"onchange":r.change(o);break;case"onclick":r.click(o);break;case"ondblclick":r.dblclick(o);break;case"oninput":r.on("input",o);break;case"onmouseenter":r.mouseenter(o);break;case"onsubmit":r.submit(o);break;default:r.attr(i,ccm.helper.val(o))}}return r},htmlEncode:function(e,n,t){return"string"!=typeof e&&(e=e.toString()),e=n||void 0===n?e.trim():e,e=jQuery("<div>").text(e).html(),e=t||void 0===t?e.replace(/"/g,"&quot;"):e},htmlDecode:function(e){return jQuery("<div>").html(e).text()},integrate:function(e,n){if(!e)return n;if(!n)return e;for(var t in e)void 0!==e[t]?n[t]=e[t]:delete n[t];return n},isComponent:function(e){return ccm.helper.isObject(e)&&e.Instance&&!0},isDataset:function(e){return ccm.helper.isObject(e)},isDatastore:function(e){return ccm.helper.isObject(e)&&e.get&&e.set&&e.del&&!0},isDependency:function(e){if(jQuery.isArray(e)&&e.length>0)switch(e[0]){case ccm.load:case"ccm.load":case ccm.component:case"ccm.component":case ccm.instance:case"ccm.instance":case ccm.proxy:case"ccm.proxy":case ccm.render:case"ccm.render":case ccm.store:case"ccm.store":case ccm.dataset:case"ccm.dataset":return!0}return!1},isElement:function(e){return e instanceof jQuery},isInDOM:function(e){return ccm.helper.tagExists(jQuery("#ccm-"+e.index))},isInstance:function(e){return ccm.helper.isObject(e)&&e.component&&!0},isObject:function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},isProxy:function(e){return ccm.helper.isInstance(e)&&"string"==typeof e.component},isSubset:function(e,n){for(var t in e)if("object"==typeof e[t]&&"object"==typeof n[t]){if(JSON.stringify(e[t])!==JSON.stringify(n[t]))return!1}else if(e[t]!==n[t])return!1;return!0},loading:function(e){(e?e:jQuery("body")).html(jQuery("<div>").css({display:"inline-block",width:"0.5em",height:"0.5em",border:"0.15em solid #009ee0","border-right-color":"transparent","border-radius":"50%",animation:"ccm_loading 1s linear infinite"}))},noScript:function(e){var n=jQuery("<div>").html(e);return n.find("script").remove(),n.html()},privatize:function(e,n){for(var t={},c=1;c<arguments.length;c++){var r=arguments[c];void 0!==e[r]&&(t[r]=e[r]),delete e[r]}return t},regex:function(e){switch(e){case"key":return/^[a-z_0-9][a-zA-Z_0-9]*$/;case"name":return/^[a-z][a-z_0-9]*$/;case"tag":return/^[a-z][a-zA-Z]*$/;case"url":return/^(((http|ftp|https):\/\/)?[\w-]+(\.[\w-]*)+)?([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?$/}},reselect:function(e){e.element&&(e.element=jQuery(e.element.selector))},solveDependency:function(e,n,t){return e[n].push(function(c){e[n]=c,t(c)}),ccm.helper.action(e[n])},tagExists:function(e){return e.closest("html").length>0},val:function(e,n){return n?n===!0?ccm.helper.htmlEncode(e):("string"==typeof n?ccm.helper.regex(n):n).test(e)?e:null:ccm.helper.noScript(e)},wait:function(e,n){window.setTimeout(n,e)}}}}();